!function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e,t){function n(e){e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files;if(n.length>0){var r=new FileReader;r.onload=function(r){var i=new Uint8Array(r.target.result);t(i,n[0].name,e)},r.readAsArrayBuffer(n[0])}return!1}function r(e){return e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy",!1}e.addEventListener("dragover",r,!1),e.addEventListener("drop",n,!1)}var i=n(1),a=n(20);window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame}(),window.addEventListener("load",function(){var e=document.getElementById("nesroot"),t=new a["default"](e);window.File&&window.FileReader&&window.FileList&&window.Blob&&r(e,function(n,r,a){var s={title:r,centerX:a.pageX,centerY:a.pageY},o=i.App.create(t,e,s);o.loadRom(n)})})},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t,n){return t>e?t:(t>n&&(n=t),e>n?n:e)}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(2),o=n(16),u=n(17),l=n(18),c=1789773,h=50,d=function(){function e(t,n,a){var c=this;r(this,e),this.wndMgr=t,this.root=n,this.destroying=!1,this.nes=s.Nes.create(),window.nes=this.nes,this.nes.setVblankCallback(function(e){c.onVblank(e)}),this.nes.setBreakPointCallback(function(){c.onBreakPoint()}),this.audioManager=new o.AudioManager,this.screenWnd=new l.ScreenWnd(this,this.wndMgr,this.nes),this.wndMgr.add(this.screenWnd),a.title&&this.screenWnd.setTitle(a.title),this.screenWnd.setCallback(function(e){switch(e){case"close":c.cleanUp()}});var h=this.screenWnd.getWindowSize(),d=i((a.centerX||0)-h.width/2,0,window.innerWidth-h.width-1),p=i((a.centerY||0)-h.height/2,0,window.innerHeight-h.height-1);this.screenWnd.setPos(d,p),this.nes.cpu.pause(!0),this.nes.reset(),this.dumpCpu(),this.padKeyHandler=new u.PadKeyHandler,this.setUpKeyEvent(this.screenWnd.getRootNode(),this.padKeyHandler),this.startLoopAnimation()}return a(e,[{key:"loadRom",value:function(e){return this.nes.setRomData(e)?(this.nes.reset(),this.nes.cpu.pause(!1),null!=this.traceWnd&&this.traceWnd.reset(),this.dumpCpu(),this.updateButtonState(),this.screenWnd.setFocus(),!0):(alert("Illegal ROM format"),!1)}},{key:"createPaletWnd",value:function(){var e=this;return null!=this.paletWnd?!1:(this.paletWnd=new l.PaletWnd(this.wndMgr,this.nes),this.wndMgr.add(this.paletWnd),this.paletWnd.setPos(520,0),this.paletWnd.setCallback(function(t){"close"===t&&(e.paletWnd=null)}),!0)}},{key:"createNameTableWnd",value:function(){var e=this;return null!=this.nameTableWnd?!1:(this.nameTableWnd=new l.NameTableWnd(this.wndMgr,this.nes),this.wndMgr.add(this.nameTableWnd),this.nameTableWnd.setPos(520,40),this.nameTableWnd.setCallback(function(t){"close"===t&&(e.nameTableWnd=null)}),!0)}},{key:"createPatternTableWnd",value:function(){var e=this;return null!=this.patternTableWnd?!1:(this.patternTableWnd=new l.PatternTableWnd(this.wndMgr,this.nes),this.wndMgr.add(this.patternTableWnd),this.patternTableWnd.setPos(520,300),this.patternTableWnd.setCallback(function(t){"close"===t&&(e.patternTableWnd=null)}),!0)}},{key:"createTraceWnd",value:function(){var e=this;return null!=this.traceWnd?!1:(this.traceWnd=new l.TraceWnd(this.wndMgr,this.nes),this.wndMgr.add(this.traceWnd),this.traceWnd.setPos(0,500),this.traceWnd.setCallback(function(t){"close"===t&&(e.traceWnd=null)}),this.dumpCpu(),!0)}},{key:"createRegisterWnd",value:function(){var e=this;return null!=this.registerWnd?!1:(this.registerWnd=new l.RegisterWnd(this.wndMgr,this.nes),this.wndMgr.add(this.registerWnd),this.registerWnd.setPos(410,500),this.registerWnd.setCallback(function(t){"close"===t&&(e.registerWnd=null)}),this.dumpCpu(),!0)}},{key:"createControlWnd",value:function(){var e=this;return null!=this.ctrlWnd?!1:(this.ctrlWnd=new l.ControlWnd(this.wndMgr,this.nes,this.screenWnd,this.audioManager),this.ctrlWnd.setCallback(function(t){switch(t){case"close":e.ctrlWnd=null;break;case"step":e.dumpCpu(),e.render();break;case"paused":e.dumpCpu();break;case"reset":e.traceWnd.reset(),e.dumpCpu()}}),this.wndMgr.add(this.ctrlWnd),this.ctrlWnd.setPos(520,500),this.updateButtonState(),!0)}},{key:"cleanUp",value:function(){this.destroying=!0,this.audioManager.destroy(),null!=this.paletWnd&&(this.paletWnd.close(),this.paletWnd=null),null!=this.nameTableWnd&&(this.nameTableWnd.close(),this.nameTableWnd=null),null!=this.patternTableWnd&&(this.patternTableWnd.close(),this.patternTableWnd=null),null!=this.registerWnd&&(this.registerWnd.close(),this.registerWnd=null),null!=this.traceWnd&&(this.traceWnd.close(),this.traceWnd=null),null!=this.ctrlWnd&&(this.ctrlWnd.close(),this.ctrlWnd=null),this.wndMgr=null}},{key:"onVblank",value:function(e){1>e&&this.render();for(var t=0;t<o.AudioManager.CHANNEL;++t)this.audioManager.setChannelFrequency(t,this.nes.apu.getFrequency(t)),this.audioManager.setChannelVolume(t,this.nes.apu.getVolume(t))}},{key:"onBreakPoint",value:function(){this.updateButtonState(),this.dumpCpu()}},{key:"startLoopAnimation",value:function(){var e=this,t=window.performance.now(),n=function r(){if(!e.destroying){var n=window.performance.now(),i=n-t;t=n,e.loop(i),requestAnimationFrame(r)}};requestAnimationFrame(n)}},{key:"loop",value:function(e){if(!this.nes.cpu.isPaused()){for(var t=0;2>t;++t)this.nes.setPadStatus(t,this.padKeyHandler.getStatus(t));var n=Math.min(e,h),r=c*n/1e3|0;this.nes.runCycles(r)}}},{key:"render",value:function(){this.wndMgr.update()}},{key:"updateButtonState",value:function(){var e=this.nes.cpu.isPaused();null!=this.ctrlWnd&&this.ctrlWnd.updateState(e)}},{key:"dumpCpu",value:function(){null!=this.registerWnd&&this.registerWnd.updateStatus(),null!=this.traceWnd&&this.traceWnd.updateStatus()}},{key:"setUpKeyEvent",value:function(e,t){e.setAttribute("tabindex","1"),e.style.outline="none",e.addEventListener("keydown",function(e){e.ctrlKey||e.altKey||e.metaKey||(e.preventDefault(),t.onKeyDown(e.keyCode))}),e.addEventListener("keyup",function(e){e.preventDefault(),t.onKeyUp(e.keyCode)})}}],[{key:"create",value:function(t,n,r){return new e(t,n,r)}}]),e}();t.App=d},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return e*(3/341)|0}function a(e){return 78===e[0]&&69===e[1]&&83===e[2]&&26===e[3]}function s(e){return e[6]>>4&15|240&e[7]}function o(e){var t=16,n=16384*e[4],r=e.slice(t,t+n);return new Uint8Array(r)}function u(e){var t=16+16384*e[4],n=8192*e[5],r=e.slice(t,t+n);return new Uint8Array(r)}var l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(3),h=n(4),d=n(5),p=n(9),f=n(7),v=n(10),y=2048,E=241,k=242,m=261,g=262,b=341*g/3|0,T=function(){function e(){r(this,e),this.cpu=new d.Cpu6502,this.ram=new Uint8Array(y),this.ppu=new p.Ppu,this.apu=new c.Apu,this.mapperNo=0,this.cycleCount=0,this.vblankCallback=function(e){},this.breakPointCallback=function(){},this.irqHlineEnable=!1,this.irqHlineValue=this.irqHlineCounter=-1,this.romData=new Uint8Array(0)}return l(e,[{key:"setVblankCallback",value:function(e){this.vblankCallback=e}},{key:"setBreakPointCallback",value:function(e){this.breakPointCallback=e}},{key:"setRomData",value:function(e){return a(e)?(this.mapperNo=s(e),this.romData=o(e),this.ppu.setChrData(u(e)),this.ppu.setMirrorMode(1&e[6]),this.cpu.deleteAllBreakPoints(),this.setMemoryMap(this.mapperNo),!0):!1}},{key:"reset",value:function(){this.ram.fill(255),this.cpu.reset(),this.ppu.reset(),this.apu.reset(),this.cycleCount=0,this.irqHlineEnable=!1,this.irqHlineValue=this.irqHlineCounter=-1}},{key:"setPadStatus",value:function(e,t){this.apu.setPadStatus(e,t)}},{key:"runCycles",value:function(e){try{for(var t=e;t>0;){var n=this.step(t);if(t-=n,this.cpu.isPaused())return this.breakPointCallback(),0}return-e}catch(r){throw this.cpu.pause(!0),r}}},{key:"step",value:function(e){var t=this.cpu.step();return this.cycleCount=this.tryHblankEvent(this.cycleCount,t,e),t}},{key:"enableIrqHline",value:function(e){this.irqHlineEnable=e}},{key:"setIrqHlineValue",value:function(e){this.irqHlineValue=e}},{key:"resetIrqHlineCounter",value:function(){this.irqHlineCounter=0}},{key:"render",value:function(e,t){this.ppu.renderBg(t),this.ppu.renderSprite(t),e.putImageData(t,0,0)}},{key:"renderNameTable",value:function(e){var t=e.getContext("2d"),n=t.getImageData(0,0,e.width,e.height);this.ppu.doRenderBg(n,0,0,0,0,0),this.ppu.doRenderBg(n,0,0,256,0,0===this.ppu.mirrorMode?2048:1024),t.putImageData(n,0,0)}},{key:"renderPatternTable",value:function(e,t){var n=e.getContext("2d"),r=n.getImageData(0,0,e.width,e.height);this.ppu.renderPattern(r,t),n.putImageData(r,0,0)}},{key:"getPalet",value:function(e){var t=this.ppu.vram,n=16128;return 63&t[n+(31&e)]}},{key:"setMemoryMap",value:function(e){var t=this,n=16404,r=this.cpu;r.resetMemoryMap(),r.setReadMemory(8192,16383,function(e){var n=7&e;return t.ppu.read(n)}),r.setWriteMemory(8192,16383,function(e,n){var r=7&e;t.ppu.write(r,n)}),r.setReadMemory(16384,24575,function(e){return t.apu.read(e)}),r.setWriteMemory(16384,24575,function(e,r){switch(e){case n:r>=0&&31>=r?t.ppu.copyWithDma(t.ram,r<<8):console.error("OAMDMA not implemented except for RAM: "+f.Util.hex(r,2));break;default:t.apu.write(e,r)}}),r.setReadMemory(0,8191,function(e){return t.ram[e&y-1]}),r.setWriteMemory(0,8191,function(e,n){t.ram[e&y-1]=n}),this.setMemoryMapForMapper(e)}},{key:"setMemoryMapForMapper",value:function(e){console.log("Mapper "+f.Util.hex(e,2)),e in v.kMapperTable?v.kMapperTable[e](this.romData,this.cpu,this.ppu,this):(console.error("  not supported"),v.kMapperTable[0](this.romData,this.cpu,this.ppu,this))}},{key:"tryHblankEvent",value:function(e,t,n){var r=e+t,a=i(e),s=i(r);if(s>a){switch(this.ppu.setHcount(s),s){case E:this.apu.isIrqEnabled()&&this.cpu.requestIrq(),this.vblankCallback(n/b),this.ppu.setVBlank();break;case k:this.interruptVBlank();break;case m:this.ppu.clearVBlank();break;case g:r-=341*g/3|0,this.ppu.hcount=0,this.irqHlineCounter=this.irqHlineValue}0!==(24&this.ppu.regs[1])&&0===--this.irqHlineCounter&&this.irqHlineEnable&&this.cpu.requestIrq()}return r}},{key:"interruptVBlank",value:function(){this.ppu.interruptEnable()&&this.interruptNmi()}},{key:"interruptNmi",value:function(){this.cpu.nmi()}}],[{key:"create",value:function(){return new e}},{key:"getPaletColorString",value:function(e){var t=h.kColors[3*e],n=h.kColors[3*e+1],r=h.kColors[3*e+2];return"rgb("+t+","+n+","+r+")"}}]),e}();t.Nes=T},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();!function(e){e[e.A=1]="A",e[e.B=2]="B",e[e.SELECT=4]="SELECT",e[e.START=8]="START",e[e.U=16]="U",e[e.D=32]="D",e[e.L=64]="L",e[e.R=128]="R"}(t.PadBit||(t.PadBit={}));var i=(t.PadBit,16384),a=16406,s=16407,o=64,u=128,l=function(){function e(){n(this,e),this.padStatus=new Array(2),this.padTmp=new Array(2),this.regs=new Uint8Array(32)}return r(e,[{key:"reset",value:function(){this.regs.fill(0),this.regs[s-i]=o}},{key:"read",value:function(e){switch(e){case 16405:return 192;case 16406:case 16407:return this.shiftPad(e-16406);default:return 0}}},{key:"write",value:function(e,t){switch(16416>e&&(this.regs[e-16384]=t),e){case a:0===(1&t)&&this.latchPad()}}},{key:"getFrequency",value:function(e){switch(e){case 0:case 1:var t=this.regs[4*e+2]+((7&this.regs[4*e+3])<<8);return 111875/(t+1)|0;case 2:var n=this.regs[4*e+2]+((7&this.regs[4*e+3])<<8);return 223750/(n+1)|0}}},{key:"getVolume",value:function(e){if(0===(this.regs[21]&1<<e))return 0;switch(e){case 0:case 1:var t=this.regs[4*e];return(15&t)/15;case 2:return 1}}},{key:"setPadStatus",value:function(e,t){this.padStatus[e]=t}},{key:"isIrqEnabled",value:function(){return 0===(this.regs[s-i]&(o|u))}},{key:"latchPad",value:function(){this.padTmp[0]=this.padStatus[0],this.padTmp[1]=this.padStatus[1]}},{key:"shiftPad",value:function(e){var t=this.padTmp[e];return this.padTmp[e]=t>>1,1&t}}]),e}();t.Apu=l},function(e,t){"use strict";var n;!function(e){e.WIDTH=256,e.HEIGHT=240}(n=t.Const||(t.Const={})),t.kColors=[124,124,124,0,0,252,0,0,188,68,40,188,148,0,132,168,0,32,168,16,0,136,20,0,80,48,0,0,120,0,0,104,0,0,88,0,0,64,88,0,0,0,0,0,0,0,0,0,188,188,188,0,120,248,0,88,248,104,68,252,216,0,204,228,0,88,248,56,0,228,92,16,172,124,0,0,184,0,0,168,0,0,168,68,0,136,136,0,0,0,0,0,0,0,0,0,248,248,248,60,188,252,104,136,252,152,120,248,248,120,248,248,88,152,248,120,88,252,160,68,248,184,0,184,248,24,88,216,84,88,248,152,0,232,216,120,120,120,0,0,0,0,0,0,252,252,252,164,228,252,184,184,248,216,184,248,248,184,248,248,164,192,240,208,176,252,224,168,248,216,120,216,248,120,184,248,184,184,248,216,0,252,252,248,216,248,0,0,0,0,0,0],t.kStaggered=function(){for(var e=8,t=1<<e,n=new Uint16Array(t),r=0;t>r;++r){for(var i=0,a=0;e>a;++a)i<<=2,0!==(r&1<<e-1-a)&&(i|=1);n[r]=i}return n}(),t.kFlipBits=function(){for(var e=8,t=1<<e,n=new Uint8Array(t),r=0;t>r;++r){for(var i=0,a=0;e>a;++a)i<<=1,0!==(r&1<<a)&&(i|=1);n[r]=i}return n}()},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t,n){return t?e|n:e&~n}function a(e){return e+1&255}function s(e){return e-1&255}function o(e){return 128>e?e:e-256}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=n(6),c=n(7),h=n(8),d=!1,p=c.Util.hex,f=0,v=1,y=2,E=4,k=5,m=6,g=7,b=1<<f,T=1<<v,A=1<<y,C=1<<E,O=1<<k,w=1<<m,P=1<<g,R=65530,I=65532,L=65534,B=8192,S=200,D=function(){var e={opType:l.OpType.UNKNOWN,addressing:l.Addressing.UNKNOWN,bytes:1,cycle:0},t=new Uint8Array(3),n=new Array(3);return function(r,i){for(var a=r.read8Raw(i),s=l.kInstTable[a]||e,o=0;o<s.bytes;++o){var u=r.read8Raw(r.pc+o);t[o]=u,n[o]=c.Util.hex(u,2)}for(var d=s.bytes;3>d;++d)n[d]="  ";var p=c.Util.hex(r.pc,4),f=n.join(" "),v=h.disassemble(s,t,1,r.pc);return p+": "+f+"   "+v}}(),M=function(){function e(){r(this,e),this.readerFuncTable=new Array(65536/B),this.writerFuncTable=new Array(65536/B),this.a=this.x=this.y=this.s=0,this.breakPoints={},this.watchRead={},this.watchWrite={},this.paused=!1,this.stepLogs=[]}return u(e,[{key:"resetMemoryMap",value:function(){this.readerFuncTable.fill(null),this.writerFuncTable.fill(null)}},{key:"setReadMemory",value:function(e,t,n){for(var r=e/B|0,i=t/B|0,a=r;i>=a;++a)this.readerFuncTable[a]=n}},{key:"setWriteMemory",value:function(e,t,n){for(var r=e/B|0,i=t/B|0,a=r;i>=a;++a)this.writerFuncTable[a]=n}},{key:"reset",value:function(){this.p=A|C|O,this.s=this.s-3&255,this.pc=this.read16(I),this.readErrorReported=this.writeErrorReported=!1,this.stepLogs.length=0}},{key:"deleteAllBreakPoints",value:function(){this.breakPoints={},this.watchRead={},this.watchWrite={}}},{key:"pause",value:function(e){this.paused=e}},{key:"isPaused",value:function(){return this.paused}},{key:"nmi",value:function(){var e=this.read16(R);this.breakPoints.nmi&&(this.paused=!0,console.warn("paused because NMI: "+c.Util.hex(this.pc,4)+", "+c.Util.hex(e,4))),d&&this.addStepLog("NMI occurred at pc="+c.Util.hex(this.pc,4)),this.push16(this.pc),this.push(this.p&~C),this.pc=e,this.p|=A}},{key:"requestIrq",value:function(){return 0!==(this.p&A)?!1:(d&&this.addStepLog("IRQ occurred at pc="+c.Util.hex(this.pc,4)),this.push16(this.pc),this.push(this.p&~C),this.pc=this.read16(L),this.p|=A,!0)}},{key:"step",value:function(){var e=this.pc;d&&this.addStepLog(D(this,e));var t=this.read8(e++),n=l.kInstTable[t];if(null==n)return console.error("Unhandled OPCODE, "+p(this.pc-1,4)+": "+p(t,2)),this.paused=!0,0;this.pc+=n.bytes;var r=this.getAdr(e,n.addressing);switch(n.opType){default:case 0:break;case 1:break;case 2:this.a=this.read8(r),this.setNZFlag(this.a);break;case 3:this.write8(r,this.a);break;case 4:this.x=this.read8(r),this.setNZFlag(this.x);break;case 5:this.write8(r,this.x);break;case 6:this.y=this.read8(r),this.setNZFlag(this.y);break;case 7:this.write8(r,this.y);break;case 8:this.x=this.a,this.setNZFlag(this.x);break;case 9:this.y=this.a,this.setNZFlag(this.y);break;case 10:this.a=this.x,this.setNZFlag(this.x);break;case 11:this.a=this.y,this.setNZFlag(this.a);break;case 12:this.s=this.x;break;case 13:this.x=this.s,this.setNZFlag(this.x);break;case 14:var i=0!==(this.p&b)?1:0,u=this.read8(r),h=this.a+u+i,f=0!==((this.a^h)&(u^h)&128);this.a=255&h,this.setNZFlag(this.a),this.setCarry(h>=256),this.setOverFlow(f);break;case 15:var v=0!==(this.p&b)?1:0,y=255-this.read8(r),E=this.a+y+v,k=0!==((this.a^E)&(y^E)&128);this.a=255&E,this.setNZFlag(this.a),this.setCarry(E>=256),this.setOverFlow(k);break;case 16:this.x=a(this.x),this.setNZFlag(this.x);break;case 17:this.y=a(this.y),this.setNZFlag(this.y);break;case 18:var m=a(this.read8(r));this.write8(r,m),this.setNZFlag(m);break;case 19:this.x=s(this.x),this.setNZFlag(this.x);break;case 20:this.y=s(this.y),this.setNZFlag(this.y);break;case 21:var g=s(this.read8(r));this.write8(r,g),this.setNZFlag(g);break;case 22:var R=this.read8(r);this.a&=R,this.setNZFlag(this.a);break;case 23:var I=this.read8(r);this.a|=I,this.setNZFlag(this.a);break;case 24:var B=this.read8(r);this.a^=B,this.setNZFlag(this.a);break;case 25:var S=null==r?this.a:this.read8(r),M=0!==(this.p&b)?1:0,N=0!==(128&S),x=255&(S<<1|M);null==r?this.a=x:this.write8(r,x),this.setNZFlag(x),this.setCarry(N);break;case 26:var U=null==r?this.a:this.read8(r),W=0!==(this.p&b)?128:0,X=0!==(1&U),H=U>>1|W;null==r?this.a=H:this.write8(r,H),this.setNZFlag(H),this.setCarry(X);break;case 27:var _=null==r?this.a:this.read8(r),Y=0!==(128&_),Z=_<<1&255;null==r?this.a=Z:this.write8(r,Z),this.setNZFlag(Z),this.setCarry(Y);break;case 28:var F=null==r?this.a:this.read8(r),G=0!==(1&F),V=F>>1&255;null==r?this.a=V:this.write8(r,V),this.setNZFlag(V),this.setCarry(G);break;case 29:var q=this.read8(r),j=this.a&q;this.setZero(0===j);var z=P|w;this.p=this.p&~z|q&z;break;case 30:var K=this.read8(r),J=this.a-K;this.setNZFlag(J),this.setCarry(J>=0);break;case 31:var $=this.read8(r),Q=this.x-$;this.setNZFlag(Q),this.setCarry(Q>=0);break;case 32:var ee=this.read8(r),te=this.y-ee;this.setNZFlag(te),this.setCarry(te>=0);break;case 33:this.pc=r;break;case 34:this.push16(this.pc-1),this.pc=r;break;case 35:this.pc=this.pop16()+1;break;case 36:this.p=this.pop()|O,this.pc=this.pop16();break;case 37:0===(this.p&b)&&(this.pc+=o(this.read8(r)));break;case 38:0!==(this.p&b)&&(this.pc+=o(this.read8(r)));break;case 39:0===(this.p&P)&&(this.pc+=o(this.read8(r)));break;case 40:0!==(this.p&P)&&(this.pc+=o(this.read8(r)));break;case 41:0===(this.p&T)&&(this.pc+=o(this.read8(r)));break;case 42:0!==(this.p&T)&&(this.pc+=o(this.read8(r)));break;case 43:0===(this.p&w)&&(this.pc+=o(this.read8(r)));break;case 44:0!==(this.p&w)&&(this.pc+=o(this.read8(r)));break;case 45:this.push(this.a);break;case 46:this.push(this.p|C);break;case 47:this.a=this.pop(),this.setNZFlag(this.a);break;case 48:this.p=this.pop()|O;break;case 49:this.p&=~b;break;case 50:this.p|=b;break;case 51:this.p|=A;break;case 52:this.p&=~A;break;case 53:this.p&=~w;break;case 54:break;case 55:break;case 56:d&&this.addStepLog("BRK occurred"),this.push16(this.pc+1),this.push(this.p|C),this.pc=this.read16(L),this.p|=A}return this.breakPoints[this.pc]&&(this.paused=!0,console.warn("paused because PC matched break point: "+c.Util.hex(this.pc,4))),n.cycle}},{key:"setNZFlag",value:function(e){this.setZero(0===e),this.setNegative(0!==(128&e))}},{key:"setCarry",value:function(e){this.p=i(this.p,e,b)}},{key:"setZero",value:function(e){this.p=i(this.p,e,T)}},{key:"setOverFlow",value:function(e){this.p=i(this.p,e,w)}},{key:"setNegative",value:function(e){this.p=i(this.p,e,P)}},{key:"read8",value:function(e){var t=this.read8Raw(e);return this.watchRead[e]&&(this.paused=!0,console.warn("Break because watched point read: adr="+c.Util.hex(e,4)+", value="+c.Util.hex(t,2))),t}},{key:"read8Raw",value:function(e){var t=e/B|0,n=this.readerFuncTable[t];return n?n(e):(this.readErrorReported||(console.error("Illegal read at "+p(e,4)+", pc="+p(this.pc,4)),this.readErrorReported=!0),0)}},{key:"read16",value:function(e){var t=this.read8(e),n=this.read8(e+1);return n<<8|t}},{key:"read16Indirect",value:function(e){var t=this.read8(e),n=this.read8((65280&e)+(e+1&255));return n<<8|t}},{key:"write8",value:function(e,t){var n=e/B|0,r=this.writerFuncTable[n];return r?(this.watchWrite[e]&&(this.paused=!0,console.warn("Break because watched point write: adr="+c.Util.hex(e,4)+", value="+c.Util.hex(t,2))),this.writerFuncTable[n](e,t)):void(this.writeErrorReported||(console.error("Illegal write at "+p(e,4)+", pc="+p(this.pc,4)+", "+p(t,2)),this.writeErrorReported=!0))}},{key:"dump",value:function(e,t){for(var n=[],r=0;t>r;++r)n.push(this.read8(r+e));for(var i=0;t>i;i+=16){var a=n.splice(0,16).map(function(e){return c.Util.hex(e,2)}).join(" ");console.log(c.Util.hex(e+i,4)+": "+a)}}},{key:"push",value:function(e){this.write8(256+this.s,e),this.s=s(this.s)}},{key:"push16",value:function(e){var t=this.s;this.write8(256+t,e>>8),t=s(t),this.write8(256+t,255&e),this.s=s(t)}},{key:"pop",value:function(){return this.s=a(this.s),this.read8(256+this.s)}},{key:"pop16",value:function(){var e=this.s;e=a(e);var t=this.read8(256+e);e=a(e);var n=this.read8(256+e);return this.s=e,n<<8|t}},{key:"addStepLog",value:function(e){if(this.stepLogs.length<S)this.stepLogs.push(e);else{for(var t=1;S>t;++t)this.stepLogs[t-1]=this.stepLogs[t];this.stepLogs[S-1]=e}}},{key:"getAdr",value:function(e,t){switch(t){case l.Addressing.ACCUMULATOR:case l.Addressing.IMPLIED:return null;case l.Addressing.IMMEDIATE:case l.Addressing.RELATIVE:return e;case l.Addressing.ZEROPAGE:return this.read8(e);case l.Addressing.ZEROPAGE_X:return this.read8(e)+this.x&255;case l.Addressing.ZEROPAGE_Y:return this.read8(e)+this.y&255;case l.Addressing.ABSOLUTE:return this.read16(e);case l.Addressing.ABSOLUTE_X:return this.read16(e)+this.x&65535;case l.Addressing.ABSOLUTE_Y:return this.read16(e)+this.y&65535;case l.Addressing.INDIRECT_X:var n=this.read8(e);return this.read16Indirect(n+this.x&255);case l.Addressing.INDIRECT_Y:var r=this.read8(e),i=this.read16Indirect(r);return i+this.y&65535;case l.Addressing.INDIRECT:var a=this.read16(e);return this.read16Indirect(a);default:return console.error("Illegal addressing: "+t),this.paused=!0,null}}}]),e}();t.Cpu6502=M},function(e,t){"use strict";var n=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(u){i=!0,a=u}finally{try{!r&&o["return"]&&o["return"]()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.IMPLIED=1]="IMPLIED",e[e.ACCUMULATOR=2]="ACCUMULATOR",e[e.IMMEDIATE=3]="IMMEDIATE",e[e.IMMEDIATE16=4]="IMMEDIATE16",e[e.ZEROPAGE=5]="ZEROPAGE",e[e.ZEROPAGE_X=6]="ZEROPAGE_X",e[e.ZEROPAGE_Y=7]="ZEROPAGE_Y",e[e.ABSOLUTE=8]="ABSOLUTE",e[e.ABSOLUTE_X=9]="ABSOLUTE_X",e[e.ABSOLUTE_Y=10]="ABSOLUTE_Y",e[e.INDIRECT=11]="INDIRECT",e[e.INDIRECT_X=12]="INDIRECT_X",e[e.INDIRECT_Y=13]="INDIRECT_Y",e[e.RELATIVE=14]="RELATIVE"}(t.Addressing||(t.Addressing={}));var r=t.Addressing;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.NOP=1]="NOP",e[e.LDA=2]="LDA",e[e.STA=3]="STA",e[e.LDX=4]="LDX",e[e.STX=5]="STX",e[e.LDY=6]="LDY",e[e.STY=7]="STY",e[e.TAX=8]="TAX",e[e.TAY=9]="TAY",e[e.TXA=10]="TXA",e[e.TYA=11]="TYA",e[e.TXS=12]="TXS",e[e.TSX=13]="TSX",e[e.ADC=14]="ADC",e[e.SBC=15]="SBC",e[e.INX=16]="INX",e[e.INY=17]="INY",e[e.INC=18]="INC",e[e.DEX=19]="DEX",e[e.DEY=20]="DEY",e[e.DEC=21]="DEC",e[e.AND=22]="AND",e[e.ORA=23]="ORA",e[e.EOR=24]="EOR",e[e.ROL=25]="ROL",e[e.ROR=26]="ROR",e[e.ASL=27]="ASL",e[e.LSR=28]="LSR",e[e.BIT=29]="BIT",e[e.CMP=30]="CMP",e[e.CPX=31]="CPX",e[e.CPY=32]="CPY",e[e.JMP=33]="JMP",e[e.JSR=34]="JSR",e[e.RTS=35]="RTS",e[e.RTI=36]="RTI",e[e.BCC=37]="BCC",e[e.BCS=38]="BCS",e[e.BPL=39]="BPL",e[e.BMI=40]="BMI",e[e.BNE=41]="BNE",e[e.BEQ=42]="BEQ",e[e.BVC=43]="BVC",e[e.BVS=44]="BVS",e[e.PHA=45]="PHA",e[e.PHP=46]="PHP",e[e.PLA=47]="PLA",e[e.PLP=48]="PLP",e[e.CLC=49]="CLC",e[e.SEC=50]="SEC",e[e.SEI=51]="SEI",e[e.CLI=52]="CLI",e[e.CLV=53]="CLV",e[e.SED=54]="SED",e[e.CLD=55]="CLD",e[e.BRK=56]="BRK"}(t.OpType||(t.OpType={}));var i=t.OpType,a=[[234,i.NOP,r.IMPLIED,1,2],[169,i.LDA,r.IMMEDIATE,2,2],[165,i.LDA,r.ZEROPAGE,2,3],[181,i.LDA,r.ZEROPAGE_X,2,4],[173,i.LDA,r.ABSOLUTE,3,4],[189,i.LDA,r.ABSOLUTE_X,3,4],[185,i.LDA,r.ABSOLUTE_Y,3,4],[161,i.LDA,r.INDIRECT_X,2,6],[177,i.LDA,r.INDIRECT_Y,2,5],[133,i.STA,r.ZEROPAGE,2,3],[149,i.STA,r.ZEROPAGE_X,2,4],[141,i.STA,r.ABSOLUTE,3,4],[157,i.STA,r.ABSOLUTE_X,3,5],[153,i.STA,r.ABSOLUTE_Y,3,5],[149,i.STA,r.ZEROPAGE_X,2,4],[129,i.STA,r.INDIRECT_X,2,6],[145,i.STA,r.INDIRECT_Y,2,6],[162,i.LDX,r.IMMEDIATE,2,2],[166,i.LDX,r.ZEROPAGE,2,3],[182,i.LDX,r.ZEROPAGE_Y,2,4],[174,i.LDX,r.ABSOLUTE,3,4],[190,i.LDX,r.ABSOLUTE_Y,3,4],[134,i.STX,r.ZEROPAGE,2,3],[150,i.STX,r.ZEROPAGE_Y,2,4],[142,i.STX,r.ABSOLUTE,3,4],[160,i.LDY,r.IMMEDIATE,2,2],[164,i.LDY,r.ZEROPAGE,2,3],[180,i.LDY,r.ZEROPAGE_X,2,4],[172,i.LDY,r.ABSOLUTE,3,4],[188,i.LDY,r.ABSOLUTE_X,3,4],[132,i.STY,r.ZEROPAGE,2,3],[148,i.STY,r.ZEROPAGE_X,2,4],[140,i.STY,r.ABSOLUTE,3,4],[170,i.TAX,r.IMPLIED,1,2],[168,i.TAY,r.IMPLIED,1,2],[138,i.TXA,r.IMPLIED,1,2],[152,i.TYA,r.IMPLIED,1,2],[154,i.TXS,r.IMPLIED,1,2],[186,i.TSX,r.IMPLIED,1,2],[105,i.ADC,r.IMMEDIATE,2,2],[101,i.ADC,r.ZEROPAGE,2,3],[117,i.ADC,r.ZEROPAGE_X,2,4],[109,i.ADC,r.ABSOLUTE,3,4],[125,i.ADC,r.ABSOLUTE_X,3,4],[121,i.ADC,r.ABSOLUTE_Y,3,4],[97,i.ADC,r.INDIRECT_X,2,6],[113,i.ADC,r.INDIRECT_Y,2,5],[233,i.SBC,r.IMMEDIATE,2,2],[229,i.SBC,r.ZEROPAGE,2,3],[245,i.SBC,r.ZEROPAGE_X,2,4],[237,i.SBC,r.ABSOLUTE,3,4],[253,i.SBC,r.ABSOLUTE_X,3,4],[249,i.SBC,r.ABSOLUTE_Y,3,4],[225,i.SBC,r.INDIRECT_X,2,6],[241,i.SBC,r.INDIRECT_Y,2,5],[201,i.CMP,r.IMMEDIATE,2,2],[197,i.CMP,r.ZEROPAGE,2,3],[213,i.CMP,r.ZEROPAGE_X,2,4],[205,i.CMP,r.ABSOLUTE,3,4],[221,i.CMP,r.ABSOLUTE_X,3,4],[217,i.CMP,r.ABSOLUTE_Y,3,4],[193,i.CMP,r.INDIRECT_X,2,6],[209,i.CMP,r.INDIRECT_Y,2,5],[224,i.CPX,r.IMMEDIATE,2,2],[228,i.CPX,r.ZEROPAGE,2,3],[236,i.CPX,r.ABSOLUTE,3,4],[192,i.CPY,r.IMMEDIATE,2,2],[196,i.CPY,r.ZEROPAGE,2,3],[204,i.CPY,r.ABSOLUTE,3,4],[232,i.INX,r.IMPLIED,1,2],[200,i.INY,r.IMPLIED,1,2],[230,i.INC,r.ZEROPAGE,2,5],[246,i.INC,r.ZEROPAGE_X,2,6],[238,i.INC,r.ABSOLUTE,3,6],[254,i.INC,r.ABSOLUTE_X,3,7],[202,i.DEX,r.IMPLIED,1,2],[136,i.DEY,r.IMPLIED,1,2],[198,i.DEC,r.ZEROPAGE,2,5],[214,i.DEC,r.ZEROPAGE_X,2,6],[206,i.DEC,r.ABSOLUTE,3,6],[222,i.DEC,r.ABSOLUTE_X,3,7],[41,i.AND,r.IMMEDIATE,2,2],[37,i.AND,r.ZEROPAGE,2,3],[53,i.AND,r.ZEROPAGE_X,2,4],[45,i.AND,r.ABSOLUTE,3,4],[61,i.AND,r.ABSOLUTE_X,3,4],[57,i.AND,r.ABSOLUTE_Y,3,4],[33,i.AND,r.INDIRECT_X,2,6],[49,i.AND,r.INDIRECT_Y,2,5],[9,i.ORA,r.IMMEDIATE,2,2],[5,i.ORA,r.ZEROPAGE,2,3],[21,i.ORA,r.ZEROPAGE_X,2,4],[13,i.ORA,r.ABSOLUTE,3,4],[29,i.ORA,r.ABSOLUTE_X,3,4],[25,i.ORA,r.ABSOLUTE_Y,3,4],[1,i.ORA,r.INDIRECT_X,2,6],[17,i.ORA,r.INDIRECT_Y,2,5],[73,i.EOR,r.IMMEDIATE,2,2],[69,i.EOR,r.ZEROPAGE,2,3],[85,i.EOR,r.ZEROPAGE_X,2,4],[77,i.EOR,r.ABSOLUTE,3,4],[93,i.EOR,r.ABSOLUTE_X,3,4],[89,i.EOR,r.ABSOLUTE_Y,3,4],[65,i.EOR,r.INDIRECT_X,2,6],[81,i.EOR,r.INDIRECT_Y,2,5],[42,i.ROL,r.ACCUMULATOR,1,2],[38,i.ROL,r.ZEROPAGE,2,5],[54,i.ROL,r.ZEROPAGE_X,2,6],[46,i.ROL,r.ABSOLUTE,3,6],[62,i.ROL,r.ABSOLUTE_X,3,7],[106,i.ROR,r.ACCUMULATOR,1,2],[102,i.ROR,r.ZEROPAGE,2,5],[118,i.ROR,r.ZEROPAGE_X,2,6],[110,i.ROR,r.ABSOLUTE,3,6],[126,i.ROR,r.ABSOLUTE_X,3,7],[10,i.ASL,r.ACCUMULATOR,1,2],[6,i.ASL,r.ZEROPAGE,2,5],[22,i.ASL,r.ZEROPAGE_X,2,6],[14,i.ASL,r.ABSOLUTE,3,6],[30,i.ASL,r.ABSOLUTE_X,3,7],[74,i.LSR,r.ACCUMULATOR,1,2],[70,i.LSR,r.ZEROPAGE,2,5],[86,i.LSR,r.ZEROPAGE_X,2,6],[78,i.LSR,r.ABSOLUTE,3,6],[94,i.LSR,r.ABSOLUTE_X,3,7],[36,i.BIT,r.ZEROPAGE,2,3],[44,i.BIT,r.ABSOLUTE,3,4],[76,i.JMP,r.ABSOLUTE,3,3],[108,i.JMP,r.INDIRECT,3,5],[32,i.JSR,r.ABSOLUTE,3,6],[96,i.RTS,r.IMPLIED,1,6],[64,i.RTI,r.IMPLIED,1,6],[144,i.BCC,r.RELATIVE,2,2],[176,i.BCS,r.RELATIVE,2,2],[16,i.BPL,r.RELATIVE,2,2],[48,i.BMI,r.RELATIVE,2,2],[208,i.BNE,r.RELATIVE,2,2],[240,i.BEQ,r.RELATIVE,2,2],[80,i.BVC,r.RELATIVE,2,2],[112,i.BVS,r.RELATIVE,2,2],[72,i.PHA,r.IMPLIED,1,3],[8,i.PHP,r.IMPLIED,1,3],[104,i.PLA,r.IMPLIED,1,4],[40,i.PLP,r.IMPLIED,1,4],[24,i.CLC,r.IMPLIED,1,2],[56,i.SEC,r.IMPLIED,1,2],[120,i.SEI,r.IMPLIED,1,2],[88,i.CLI,r.IMPLIED,1,2],[184,i.CLV,r.IMPLIED,1,2],[248,i.SED,r.IMPLIED,1,2],[216,i.CLD,r.IMPLIED,1,2],[0,i.BRK,r.IMPLIED,1,7]];t.kInstTable=function(){var e=new Array(256);return e.fill(null),a.forEach(function(t){var r=n(t,5),i=r[0],a=r[1],s=r[2],o=r[3],u=r[4];e[i]={opType:a,addressing:s,bytes:o,cycle:u}}),e}()},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i="0123456789abcdef";"fill"in Array.prototype||(Array.prototype.fill=function(e){for(var t=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=arguments.length<=2||void 0===arguments[2]?this.length:arguments[2],r=t;n>r;++r)this[r]=e;return this}),"fill"in Uint8Array.prototype||(Uint8Array.prototype.fill=function(e){for(var t=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=arguments.length<=2||void 0===arguments[2]?this.length:arguments[2],r=t;n>r;++r)this[r]=e;return this}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(e,t){void 0==t&&(t=this.length);for(var n=new Uint8Array(t-e),r=0;r<n.length;++r)n[r]=this[r+e];return n});var a=function(){function e(){n(this,e)}return r(e,null,[{key:"hex",value:function(e,t){t=t||2;for(var n=new Array(t),r=0;t>r;++r)n[t-r-1]=i[15&e],e>>=4;return n.join("")}}]),e}();t.Util=a},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t,n,r){var i="";switch(e.addressing){case s.Addressing.IMPLIED:case s.Addressing.ACCUMULATOR:break;case s.Addressing.IMMEDIATE:i=" #$"+o.Util.hex(t[n],2);break;case s.Addressing.IMMEDIATE16:i=" #$"+o.Util.hex(t[n]|t[n+1]<<8,4);break;case s.Addressing.ZEROPAGE:i=" $"+o.Util.hex(t[n],2);break;case s.Addressing.ZEROPAGE_X:i=" $"+o.Util.hex(t[n],2)+", X";break;case s.Addressing.ZEROPAGE_Y:i=" $"+o.Util.hex(t[n],2)+", Y";break;case s.Addressing.ABSOLUTE:i=" $"+o.Util.hex(t[n]|t[n+1]<<8,4);break;case s.Addressing.ABSOLUTE_X:i=" $"+o.Util.hex(t[n]|t[n+1]<<8,4)+", X";break;case s.Addressing.ABSOLUTE_Y:i=" $"+o.Util.hex(t[n]|t[n+1]<<8,4)+", Y";break;case s.Addressing.INDIRECT:i=" ($"+o.Util.hex(t[n]|t[n+1]<<8,4)+")";break;case s.Addressing.INDIRECT_X:i=" ($"+o.Util.hex(t[n],2)+", X)";break;case s.Addressing.INDIRECT_Y:i=" ($"+o.Util.hex(t[n],2)+"), Y";break;case s.Addressing.RELATIVE:var a=t[n];i=128>a?" +"+a+"  ; $"+o.Util.hex(r+e.bytes+a,4):" "+(a-256)+"  ; $"+o.Util.hex(r+e.bytes+a-256,4);
break;default:console.error("Unhandled addressing: "+e.addressing)}return""+u[e.opType]+i}var a,s=n(6),o=n(7),u=(a={},r(a,s.OpType.LDA,"LDA"),r(a,s.OpType.STA,"STA"),r(a,s.OpType.LDX,"LDX"),r(a,s.OpType.STX,"STX"),r(a,s.OpType.LDY,"LDY"),r(a,s.OpType.STY,"STY"),r(a,s.OpType.TAX,"TAX"),r(a,s.OpType.TAY,"TAY"),r(a,s.OpType.TXA,"TXA"),r(a,s.OpType.TYA,"TYA"),r(a,s.OpType.TXS,"TXS"),r(a,s.OpType.TSX,"TSX"),r(a,s.OpType.ADC,"ADC"),r(a,s.OpType.SBC,"SBC"),r(a,s.OpType.INX,"INX"),r(a,s.OpType.INY,"INY"),r(a,s.OpType.INC,"INC"),r(a,s.OpType.DEX,"DEX"),r(a,s.OpType.DEY,"DEY"),r(a,s.OpType.DEC,"DEC"),r(a,s.OpType.AND,"AND"),r(a,s.OpType.ORA,"ORA"),r(a,s.OpType.EOR,"EOR"),r(a,s.OpType.ROL,"ROL"),r(a,s.OpType.ROR,"ROR"),r(a,s.OpType.ASL,"ASL"),r(a,s.OpType.LSR,"LSR"),r(a,s.OpType.BIT,"BIT"),r(a,s.OpType.CMP,"CMP"),r(a,s.OpType.CPX,"CPX"),r(a,s.OpType.CPY,"CPY"),r(a,s.OpType.JMP,"JMP"),r(a,s.OpType.JSR,"JSR"),r(a,s.OpType.RTS,"RTS"),r(a,s.OpType.RTI,"RTI"),r(a,s.OpType.BCC,"BCC"),r(a,s.OpType.BCS,"BCS"),r(a,s.OpType.BPL,"BPL"),r(a,s.OpType.BMI,"BMI"),r(a,s.OpType.BNE,"BNE"),r(a,s.OpType.BEQ,"BEQ"),r(a,s.OpType.BVC,"BVC"),r(a,s.OpType.BVS,"BVS"),r(a,s.OpType.PHA,"PHA"),r(a,s.OpType.PHP,"PHP"),r(a,s.OpType.PLA,"PLA"),r(a,s.OpType.PLP,"PLP"),r(a,s.OpType.CLC,"CLC"),r(a,s.OpType.SEC,"SEC"),r(a,s.OpType.SEI,"SEI"),r(a,s.OpType.CLI,"CLI"),r(a,s.OpType.CLV,"CLV"),r(a,s.OpType.SED,"SED"),r(a,s.OpType.CLD,"CLD"),r(a,s.OpType.BRK,"BRK"),r(a,s.OpType.NOP,"NOP"),a);t.disassemble=i},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return e.concat()}function a(e,t,n,r){var i=8192+e;return r===M?-1025&(i^(n/30&1)<<11):-2049&(i^(32&t)<<5)}function s(e,t){return e>=12288&&16128>e&&(e-=4096),e>=8192&&12288>e&&(e&=t===M?-1025:-2049),e>=16128&&16383>=e&&(e&=65311,16144===(65523&e)&&(e&=65519)),e}function o(e,t){var n=0!==(t&m)?32:1;return e+n&d-1}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=n(4),c=n(7),h=8,d=16384,p=256,f=0,v=128,y=32,E=16,k=8,m=4,g=3,b=1,T=8,A=16,C=2,O=128,w=64,P=3,R=4,I=5,L=6,B=7,S=64,D=128,M=0,N=[9,1,0,1,0,2,2,13,8,16,8,36,0,0,4,44,9,1,52,3,0,4,0,20,8,58,0,2,0,32,44,8],x=function(){function e(){r(this,e),this.regs=new Uint8Array(h),this.vram=new Uint8Array(d),this.oam=new Uint8Array(p),this.mirrorMode=0,this.hevents={count:0,events:[]},this.hevents2={count:0,events:[]},this.chrBankOffset=new Array(8);for(var t=0;8>t;++t)this.chrBankOffset[t]=t<<10}return u(e,[{key:"reset",value:function(){this.regs.fill(0),this.vram.fill(0),this.oam.fill(0),this.hcount=0,this.scrollX=this.scrollY=0,this.ppuAddr=0,this.latch=0,this.bufferedValue=0,this.hevents={count:0,events:[]},this.hevents2={count:0,events:[]};for(var e=0;8>e;++e)this.chrBankOffset[e]=e<<10;for(var t=0;32>t;++t)this.vram[16128+t]=N[t]}},{key:"setChrData",value:function(e){e&&e.length>0?this.chrData=e:this.chrData=this.vram}},{key:"setChrBank",value:function(e){for(var t=0;8>t;++t)this.setChrBankOffset(t,(e<<3)+t)}},{key:"setChrBankOffset",value:function(e,t){var n=this.chrData.length;this.chrBankOffset[e]=t<<10&n-1,this.addHevent({scrollX:this.scrollX,scrollY:this.scrollY,ppuCtrl:this.regs[f],ppuMask:this.regs[b],chrBankOffset:i(this.chrBankOffset)})}},{key:"setMirrorMode",value:function(e){this.mirrorMode=e}},{key:"read",value:function(e){var t=this.regs[e];switch(e){case C:this.regs[C]&=~O,this.latch=0;break;case R:t=this.oam[this.regs[P]];break;case B:var n=this.ppuAddr,r=s(n,this.mirrorMode);r>=16128&&16383>=r?(t=this.readPpuDirect(r),this.bufferedValue=this.readPpuDirect(s(n-4096,this.mirrorMode))):(t=this.bufferedValue,this.bufferedValue=this.readPpuDirect(r)),this.ppuAddr=o(n,this.regs[f])}return t}},{key:"write",value:function(e,t){switch(this.regs[e]=t,e){case f:this.addHevent({scrollX:this.scrollX,scrollY:this.scrollY,ppuCtrl:this.regs[f],ppuMask:this.regs[b],chrBankOffset:i(this.chrBankOffset)});break;case R:var n=this.regs[P];this.oam[n]=t,this.regs[P]=n+1&255;break;case I:0===this.latch?this.scrollX=t:(this.scrollY=t,this.addHevent({scrollX:this.scrollX,scrollY:this.scrollY,ppuCtrl:this.regs[f],ppuMask:this.regs[b],chrBankOffset:i(this.chrBankOffset)})),this.latch=1-this.latch;break;case L:0===this.latch?this.ppuAddr=t:this.ppuAddr=(this.ppuAddr<<8|t)&d-1,this.latch=1-this.latch;break;case B:var r=s(this.ppuAddr,this.mirrorMode);this.vram[r]=t,this.ppuAddr=o(this.ppuAddr,this.regs[f])}}},{key:"copyWithDma",value:function(e,t){for(var n=this.oam,r=this.regs[P],i=0;256>i;++i)n[r]=e[t+i],r=r+1&255}},{key:"setVBlank",value:function(){this.regs[C]=this.regs[C]|O;var e=this.hevents;this.hevents=this.hevents2,this.hevents2=e,this.hevents.count=0,this.addHevent({scrollX:this.scrollX,scrollY:this.scrollY,ppuCtrl:this.regs[f],ppuMask:this.regs[b],chrBankOffset:i(this.chrBankOffset)})}},{key:"clearVBlank",value:function(){this.regs[C]&=~(O|w)}},{key:"interruptEnable",value:function(){return 0!==(this.regs[f]&v)}},{key:"getBgPatternTableAddress",value:function(){return(this.regs[f]&E)<<8}},{key:"getSpritePatternTableAddress",value:function(){return 0===(this.regs[f]&y)?(this.regs[f]&k)<<9:0}},{key:"isSprite8x16",value:function(){return 0!==(this.regs[f]&y)}},{key:"renderBg",value:function(e){return 0===(this.regs[b]&T)?this.clearBg(e):void this.doRenderBgLine(e)}},{key:"doRenderBg",value:function(e,t,n,r,i,s){var o=this,u=function(e,t){var n=e+t,r=n>>10&7,i=o.chrBankOffset[r],a=1023&n,s=i+a;return l.kStaggered[o.chrData[s+8]]<<1|l.kStaggered[o.chrData[s]]},c=8,h=e.width,d=this.getBgPatternTableAddress(),p=this.vram,f=16128,v=e.data,y=63&p[f],E=l.kColors[3*y+0],k=l.kColors[3*y+1],m=l.kColors[3*y+2];n>=240&&(n-=256);for(var g=0;g<l.Const.HEIGHT/c+1;++g)for(var b=(g+(n>>3)+60)%60,T=b%30,A=0;A<l.Const.WIDTH/c+1;++A)for(var C=A+(t>>3)&63,O=31&C,w=a(s,C,b,this.mirrorMode),P=p[w+O+(T<<5)],R=16*P+d,I=(2&O)+((2&T)<<1),L=(O>>2)+(T<<1&248),B=w+960,S=(p[B+L]>>I&3)<<2,D=0;c>D;++D){var M=g*c+D-(7&n);if(!(0>M)){if(M>=l.Const.HEIGHT)break;for(var N=u(R,D),x=0;c>x;++x){var U=A*c+x-(7&t);if(!(0>U)){if(U>=l.Const.WIDTH)break;var W=N>>(c-1-x<<1)&3,X=E,H=k,_=m;if(0!==W){var Y=S+W,Z=63&p[f+Y],F=3*Z;X=l.kColors[F],H=l.kColors[F+1],_=l.kColors[F+2]}var G=4*((M+i)*h+(U+r));v[G+0]=X,v[G+1]=H,v[G+2]=_}}}}}},{key:"doRenderBgLine",value:function(e){for(var t=this.hevents.count,n=0;t>n;++n){var r=this.hevents.events[n],i=r.hcount,a=t-1>n?this.hevents.events[n+1].hcount:248;if(!(i>=a)){var s=(r.ppuCtrl&g)<<10,o=(r.ppuCtrl&E)<<8;this.doRenderBg2(e,r.scrollX,r.scrollY,s,i,a,r.chrBankOffset,o)}}}},{key:"doRenderBg2",value:function(e,t,n,r,i,s,o,u){var c=this,h=function(e,t,n){var r=e+t,i=r>>10&7,a=n[i],s=1023&r,o=a+s;return l.kStaggered[c.chrData[o+8]]<<1|l.kStaggered[c.chrData[o]]},d=8,p=e.width,f=this.vram,v=16128,y=e.data,E=63&f[v],k=l.kColors[3*E+0],m=l.kColors[3*E+1],g=l.kColors[3*E+2];n>=240&&(n-=256);for(var b=i/8|0,T=(s+7)/8|0,A=0,C=b;T>C;++C)for(var O=(C+(n>>3)+60)%60,w=O%30,P=0;P<l.Const.WIDTH/d+1;++P){for(var R=P+(t>>3)&63,I=31&R,L=a(r,R,O,this.mirrorMode),B=f[L+I+(w<<5)],S=16*B+u,D=(2&I)+((2&w)<<1),M=(I>>2)+(w<<1&248),N=L+960,x=(f[N+M]>>D&3)<<2,U=A;d>U;++U){var W=C*d+U-(7&n);if(!(0>W)){if(W>=l.Const.HEIGHT)break;for(var X=h(S,U,o),H=0;d>H;++H){var _=P*d+H-(7&t);if(!(0>_)){if(_>=l.Const.WIDTH)break;var Y=X>>(d-1-H<<1)&3,Z=k,F=m,G=g;if(0!==Y){var V=x+Y,q=63&f[v+V],j=3*q;Z=l.kColors[j],F=l.kColors[j+1],G=l.kColors[j+2]}var z=4*(W*p+_);y[z+0]=Z,y[z+1]=F,y[z+2]=G}}}}A=0}}},{key:"clearBg",value:function(e){for(var t=4*e.width,n=e.data,r=0;r<e.height;++r)for(var i=r*t,a=0;a<e.width;++a)n[i++]=0,n[i++]=0,n[i++]=0,n[i++]=255}},{key:"setHcount",value:function(e){this.hcount=e,this.checkSprite0Hit(e)}},{key:"renderSprite",value:function(e){if(0!==(this.regs[b]&A))for(var t=0,n=this.hevents.count,r=0;n>r;++r){var i=this.hevents.events[r],a=i.hcount,s=n-1>r?this.hevents.events[r+1].hcount:248;a>=s||(0===(this.regs[f]&y)&&(t=(this.regs[f]&k)<<9),this.renderSprite2(e,a,s,i.chrBankOffset,t))}}},{key:"renderSprite2",value:function(e,t,n,r,i){for(var a=this,s=function(e,t,n){var i=e+(7&t)+((8&t)<<1),s=i>>10&7,o=r[s],u=1023&i,c=o+u,h=a.chrData[c+8],d=a.chrData[c];return n&&(h=l.kFlipBits[h],d=l.kFlipBits[d]),l.kStaggered[h]<<1|l.kStaggered[d]},o=8,u=e.width,c=3,h=this.oam,d=this.vram,p=16144,f=e.data,v=this.isSprite8x16(),y=v?16:8,E=64;--E>=0;){var k=h[4*E]+1;if(!(t>k||k>=n))for(var m=h[4*E+1],g=h[4*E+2],b=0!==(g&D),T=0!==(g&S),A=h[4*E+3],C=v?16*(254&m)+((1&m)<<12):16*m+i,O=(g&c)<<2,w=0;y>w&&!(k+w>=l.Const.HEIGHT);++w)for(var P=b?y-1-w:w,R=s(C,P,T),I=0;o>I&&!(A+I>=l.Const.WIDTH);++I){var L=R>>(o-1-I<<1)&3;if(0!==L){var B=O+L,M=63&d[p+B],N=3*M,x=4*((k+w)*u+(A+I));f[x+0]=l.kColors[N],f[x+1]=l.kColors[N+1],f[x+2]=l.kColors[N+2]}}}}},{key:"dumpVram",value:function(e,t){for(var n=[],r=0;t>r;++r)n.push(this.vram[s(e+r,this.mirrorMode)]);for(var i=0;t>i;i+=16){var a=n.splice(0,16).map(function(e){return c.Util.hex(e,2)}).join(" ");console.log(c.Util.hex(e+i,4)+": "+a)}}},{key:"renderPattern",value:function(e,t){for(var n=8,r=e.width,i=e.data,a=0;2>a;++a)for(var s=0;16>s;++s)for(var o=0;16>o;++o)for(var u=16*(o+16*s+256*a),c=0;n>c;++c)for(var h=s*n+c,d=u+c,p=l.kStaggered[this.readPpuDirect(d+8)]<<1|l.kStaggered[this.readPpuDirect(d)],f=0;n>f;++f){var v=o*n+f+a*(16*n),y=p>>(n-1-f<<1)&3,E=3*y,k=4*(h*r+v);i[k+0]=t[E+0],i[k+1]=t[E+1],i[k+2]=t[E+2]}}},{key:"checkSprite0Hit",value:function(e){if(0===(this.regs[C]&w)&&(this.regs[b]&(T|A))===(T|A)){var t=this.oam[0];if(!(t>e||e>=t+16)){var n=this.oam[3];if(!(n>=255)){var r=this.getNonEmptySprite0Line();0>r||e!==t+r||(this.regs[C]|=w)}}}}},{key:"getNonEmptySprite0Line",value:function(){for(var e=this,t=function(t,n){var r=t+(7&n)+((8&n)<<1),i=r>>10&7,a=e.chrBankOffset[i],s=1023&r,o=a+s,u=e.chrData[o+8],c=e.chrData[o];return l.kStaggered[u]<<1|l.kStaggered[c]},n=this.oam,r=this.getSpritePatternTableAddress(),i=this.isSprite8x16(),a=i?16:8,s=0,o=n[4*s+1],u=n[4*s+2],c=0!==(u&D),h=i?16*(254&o)+((1&o)<<12):16*o+r,d=0;a>d;++d){var p=c?a-1-d:d,f=t(h,p);if(0!==f)return d}return-1}},{key:"addHevent",value:function(e){var t=this.hcount;t>=240&&(t=0);var n=this.hevents,r=n.count;(0>=r||n.events[r-1].hcount!==t)&&++r>=n.events.length&&n.events.push({});var i=n.events[r-1];i.hcount=t,Object.keys(e).forEach(function(t){i[t]=e[t]}),n.count=r}},{key:"readPpuDirect",value:function(e){if(e>=8192)return this.vram[e];var t=this.chrBankOffset[e>>10&7];return this.chrData[(1023&e)+t]}}]),e}();t.Ppu=x},function(e,t,n){"use strict";var r=n(11),i=n(12),a=n(13),s=n(14),o=n(15);t.kMapperTable={0:r.mapper00,1:i.mapper01,2:a.mapper02,3:s.mapper03,4:o.mapper04}},function(e,t){"use strict";function n(e,t,n){t.setReadMemory(32768,49151,function(t){return e[t&e.length-1]}),t.setReadMemory(49152,65535,function(t){return e[t&e.length-1]})}t.mapper00=n},function(e,t){"use strict";function n(e,t,n){var r=16384,i=e.length,a=16,s=3,o=[0,i-r],u=function(){a=16};t.setReadMemory(32768,65535,function(t){var n=t>>14&1,r=16383&t;return e[o[n]+r]}),t.setWriteMemory(32768,65535,function(e,t){if(0!==(128&t))return u();var l=0!==(1&a);if(a=a>>1|(1&t)<<4,l){switch(57344&e){case 32768:var c=3&a;switch(c){case 2:n.setMirrorMode(1);break;case 3:n.setMirrorMode(0)}switch(s=a>>2&3){case 2:o[0]=0;break;case 3:o[1]=i-r}break;case 40960:case 49152:for(var h=(e-40960&8192)>>1,d=0;4>d;++d)n.setChrBankOffset(h+d,t+d);break;case 57344:var p=15&a;switch(s){case 0:case 1:o[0]=(-2&p)<<14,o[1]=(1|p)<<14;break;case 2:o[1]=p<<14;break;case 3:o[0]=p<<14}}u()}});var l=new Uint8Array(8192);t.setReadMemory(24576,32767,function(e){return l[8191&e]}),t.setWriteMemory(24576,32767,function(e,t){l[8191&e]=t})}t.mapper01=n},function(e,t){"use strict";function n(e,t,n){var r=16384,i=e.length,a=i/r,s=0;t.setReadMemory(32768,49151,function(t){return e[(t&r-1)+s]}),t.setReadMemory(49152,65535,function(t){return e[(t&r-1)+i-r]}),t.setWriteMemory(32768,65535,function(e,t){s=(t&a-1)*r})}t.mapper02=n},function(e,t){"use strict";function n(e,t,n){t.setReadMemory(32768,49151,function(t){return e[t&e.length-1]}),t.setReadMemory(49152,65535,function(t){return e[t&e.length-1]}),t.setWriteMemory(32768,65535,function(e,t){n.setChrBank(t)})}t.mapper03=n},function(e,t,n){"use strict";function r(e,t,n,r){var a=(e.length>>13)-1,s=0,o=1,u=2,l=a<<13,c=new Uint8Array(8),h=function(e){0===(64&e)?(s=(c[6]&a)<<13,o=(c[7]&a)<<13,u=a-1<<13):(u=(c[6]&a)<<13,o=(c[7]&a)<<13,s=a-1<<13)},d=function(e){0===(128&e)?(n.setChrBankOffset(0,254&c[0]),n.setChrBankOffset(1,1|c[0]),n.setChrBankOffset(2,254&c[1]),n.setChrBankOffset(3,1|c[1]),n.setChrBankOffset(4,c[2]),n.setChrBankOffset(5,c[3]),n.setChrBankOffset(6,c[4]),n.setChrBankOffset(7,c[5])):(n.setChrBankOffset(4,254&c[0]),n.setChrBankOffset(5,1|c[0]),n.setChrBankOffset(6,254&c[1]),n.setChrBankOffset(7,1|c[1]),n.setChrBankOffset(0,c[2]),n.setChrBankOffset(1,c[3]),n.setChrBankOffset(2,c[4]),n.setChrBankOffset(3,c[5]))};t.setReadMemory(32768,40959,function(t){return e[(8191&t)+s]}),t.setReadMemory(40960,49151,function(t){return e[(8191&t)+o]}),t.setReadMemory(49152,57343,function(t){return e[(8191&t)+u]}),t.setReadMemory(57344,65535,function(t){return e[(8191&t)+l]});var p=new Uint8Array(8192);t.setReadMemory(24576,32767,function(e){return p[8191&e]}),t.setWriteMemory(24576,32767,function(e,t){p[8191&e]=t});var f=0;t.setWriteMemory(32768,40959,function(e,t){if(0===(1&e))f=t,h(f),d(f);else{var n=7&f;c[n]=t,6>n?d(f):h(f)}}),t.setWriteMemory(40960,49151,function(e,t){0===(1&e)?n.setMirrorMode(1-(1&t)):console.log("RAM write protect: "+i.Util.hex(t,2))}),t.setWriteMemory(49152,57343,function(e,t){0===(1&e)?r.setIrqHlineValue(t):r.resetIrqHlineCounter()}),t.setWriteMemory(57344,65535,function(e,t){0===(1&e)?(r.enableIrqHline(!1),r.resetIrqHlineCounter()):r.enableIrqHline(!0)}),h(f),n.setMirrorMode(1)}var i=n(7);t.mapper04=r},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=["square","square","triangle"],a=function(){function e(){n(this,e)}return r(e,[{key:"destroy",value:function(){null!=this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),null!=this.oscillator&&(this.oscillator.disconnect(),this.oscillator=null)}},{key:"create",value:function(e,t){return this.gainNode=e.createGain(),this.gainNode.gain.value=0,this.oscillator=e.createOscillator(),this.oscillator.type=t,this.oscillator.connect(this.gainNode),this.gainNode.connect(e.destination),this}},{key:"start",value:function(){return this.oscillator.start(),this}},{key:"setFrequency",value:function(e){this.oscillator.frequency.setValueAtTime(e,0)}},{key:"setVolume",value:function(e){this.gainNode.gain.value=e}}]),e}(),s=function(){function e(){var t=this;n(this,e);var r=window.AudioContext||window.webkitAudioContext;return null==r?(this.context=null,void(this.masterVolume=0)):(this.context=new r,null==this.context.close&&(this.context.close=function(){}),this.masterVolume=1,void(this.channels=i.map(function(e){var n=new a;return n.create(t.context,e).start(),n})))}return r(e,[{key:"destroy",value:function(){if(null!=this.context){var e=!0,t=!1,n=void 0;try{for(var r,i=this.channels[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){var a=r.value;a.destroy()}}catch(s){t=!0,n=s}finally{try{!e&&i["return"]&&i["return"]()}finally{if(t)throw n}}this.context.close(),this.context=null}}},{key:"setChannelFrequency",value:function(e,t){null!=this.context&&this.channels[e].setFrequency(t)}},{key:"setChannelVolume",value:function(e,t){null!=this.context&&this.channels[e].setVolume(t*this.masterVolume)}},{key:"setMasterVolume",value:function(e){if(null!=this.context&&(this.masterVolume=e,0>=e)){var t=!0,n=!1,r=void 0;try{for(var i,a=this.channels[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;s.setVolume(0)}}catch(o){n=!0,r=o}finally{try{!t&&a["return"]&&a["return"]()}finally{if(n)throw r}}}}}]),e}();s.CHANNEL=3,t.AudioManager=s},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i,a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(3);!function(e){e[e.SPACE=32]="SPACE",e[e.RETURN=13]="RETURN",e[e.LEFT=37]="LEFT",e[e.UP=38]="UP",e[e.RIGHT=39]="RIGHT",e[e.DOWN=40]="DOWN",e[e.Z=90]="Z",e[e.X=88]="X",e[e.I=73]="I",e[e.J=74]="J",e[e.K=75]="K",e[e.L=76]="L",e[e.Q=81]="Q",e[e.W=87]="W",e[e.O=79]="O",e[e.P=80]="P"}(i||(i={}));var o=function(){var e={};return e[i.LEFT]={no:0,bit:s.PadBit.L},e[i.RIGHT]={no:0,bit:s.PadBit.R},e[i.UP]={no:0,bit:s.PadBit.U},e[i.DOWN]={no:0,bit:s.PadBit.D},e[i.Z]={no:0,bit:s.PadBit.B},e[i.X]={no:0,bit:s.PadBit.A},e[i.SPACE]={no:0,bit:s.PadBit.SELECT},e[i.RETURN]={no:0,bit:s.PadBit.START},e[i.J]={no:1,bit:s.PadBit.L},e[i.L]={no:1,bit:s.PadBit.R},e[i.I]={no:1,bit:s.PadBit.U},e[i.K]={no:1,bit:s.PadBit.D},e[i.Q]={no:1,bit:s.PadBit.B},e[i.W]={no:1,bit:s.PadBit.A},e[i.O]={no:1,bit:s.PadBit.SELECT},e[i.P]={no:1,bit:s.PadBit.START},e}(),u=function(){function e(){r(this,e),this.controller=[0,0]}return a(e,[{key:"onKeyDown",value:function(e){var t=o[e];t&&(this.controller[t.no]|=t.bit)}},{key:"onKeyUp",value:function(e){var t=o[e];t&&(this.controller[t.no]&=~t.bit)}},{key:"getStatus",value:function(e){return this.controller[e]}}]),e}();t.PadKeyHandler=u},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){var t=e.getContext("2d");t.strokeStyle="",t.fillStyle="rgb(64,64,64)",t.fillRect(0,0,e.width,e.height)}function o(e,t,n){var r=document.createElement("img"),i=String(Date.now());r.src=t.capture(),r.className="pixelated",r.style.width=r.style.height="100%",r.title=r.alt=i;var a=new c["default"](e,v,y,i);return a.setContent(r),a.addResizeBox(),e.add(a),a}var u=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(u){i=!0,a=u}finally{try{!r&&o["return"]&&o["return"]()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(19),h=n(2),d=n(6),p=n(8),f=n(7),v=256,y=240,E=function(e){function t(e,n,a){r(this,t);var u=i(this,Object.getPrototypeOf(t).call(this,n,2*v,2*y,"NES"));u.app=e,u.nes=a,u.addMenuBar([{label:"File",submenu:[{label:"Pause",click:function(){u.nes.cpu.pause(!u.nes.cpu.paused)}},{label:"Reset",click:function(){u.nes.reset()}},{label:"Screenshot",click:function(){o(u.wndMgr,u)}},{label:"Quit",click:function(){u.close()}}]},{label:"View",submenu:[{label:"1x1",click:function(){u.setClientSize(v,y)}},{label:"2x2",click:function(){u.setClientSize(2*v,2*y)}},{label:"Adjust aspect ratio",click:function(){var e=u.getRootNode(),t=parseInt(e.style.width),n=t*(y/v)|0;u.setClientSize(t,n)}},{label:"Max",click:function(){u.setClientSize(window.innerWidth-2,window.innerHeight-c["default"].HEADER_HEIGHT-2),u.setPos(0,0)}}]},{label:"Debug",submenu:[{label:"Palette",click:function(){u.app.createPaletWnd()}},{label:"NameTable",click:function(){u.app.createNameTableWnd()}},{label:"PatternTable",click:function(){u.app.createPatternTableWnd()}},{label:"Trace",click:function(){u.app.createTraceWnd()}},{label:"Registers",click:function(){u.app.createRegisterWnd()}},{label:"Control",click:function(){u.app.createControlWnd()}}]}]);var l=document.createElement("canvas");return l.width=v,l.height=y,l.style.width="100%",l.style.height="100%",l.className="pixelated",s(l),u.setContent(l),u.canvas=l,u.context=u.canvas.getContext("2d"),u.imageData=u.context.getImageData(0,0,u.canvas.width,u.canvas.height),u.addResizeBox(),u}return a(t,e),l(t,[{key:"update",value:function(){this.nes.render(this.context,this.imageData)}},{key:"capture",value:function(){return this.canvas.toDataURL()}}]),t}(c["default"]);t.ScreenWnd=E;var k=function(e){function t(e,n){r(this,t);var a=i(this,Object.getPrototypeOf(t).call(this,e,128,16,"Palette"));a.nes=n,a.palet=new Uint8Array(t.W*t.H),a.tmp=new Uint8Array(t.W*t.H);var s=t.createDom(),o=u(s,2),l=o[0],c=o[1];return a.setContent(l),a.boxes=c,a}return a(t,e),l(t,[{key:"update",value:function(){var e=this.tmp;t.getPalet(this.nes,e);for(var n=t.W*t.H,r=0;n>r;++r){var i=e[r];i!==this.palet[r]&&(this.palet[r]=i,this.boxes[r].style.backgroundColor=h.Nes.getPaletColorString(i))}}}],[{key:"createDom",value:function(){var e=t.UNIT,n=t.W,r=t.H,i=document.createElement("div");i.className="clearfix",i.style.width=e*n+"px",i.style.height=e*r+"px";for(var a=new Array(n*r),s=0;r>s;++s)for(var o=0;n>o;++o){var u=document.createElement("div");u.className="pull-left",u.style.width=e-1+"px",u.style.height=e-1+"px",u.style.borderRight=u.style.borderBottom="1px solid black",a[o+s*n]=u,i.appendChild(u)}return[i,a]}},{key:"getPalet",value:function(e,n){for(var r=t.W*t.H,i=0;r>i;++i)n[i]=e.getPalet(i)}}]),t}(c["default"]);k.UNIT=8,k.W=16,k.H=2,t.PaletWnd=k;var m=function(e){function t(e,n){r(this,t);var a=i(this,Object.getPrototypeOf(t).call(this,e,512,240,"NameTable"));a.nes=n;var o=document.createElement("canvas");return o.width=512,o.height=240,o.style.width="512px",o.style.height="240px",o.className="pixelated",s(o),a.setContent(o),a.canvas=o,a}return a(t,e),l(t,[{key:"update",value:function(){this.nes.renderNameTable(this.canvas)}}]),t}(c["default"]);t.NameTableWnd=m;var g=[0,0,0,255,0,0,0,255,0,0,0,255],b=function(e){function t(e,n){r(this,t);var a=i(this,Object.getPrototypeOf(t).call(this,e,256,128,"PatternTable"));a.nes=n;var s=t.createCanvas();return a.setContent(s),a.canvas=s,a}return a(t,e),l(t,[{key:"update",value:function(){this.nes.renderPatternTable(this.canvas,g)}}],[{key:"createCanvas",value:function(){var e=document.createElement("canvas");return e.width=256,e.height=128,e.style.width="256px",e.style.height="128px",e.className="pixelated",s(e),e}}]),t}(c["default"]);t.PatternTableWnd=b;var T=function(e){function t(e,n){r(this,t);var a=i(this,Object.getPrototypeOf(t).call(this,e,100,160,"Regs"));a.nes=n;var s=a.createContent();return a.setContent(s),a}return a(t,e),l(t,[{key:"updateStatus",value:function(){var e=this.nes.cpu;this.valueElems[0].value=f.Util.hex(e.pc,4),this.valueElems[1].value=f.Util.hex(e.a,2),this.valueElems[2].value=f.Util.hex(e.x,2),this.valueElems[3].value=f.Util.hex(e.y,2),this.valueElems[4].value=f.Util.hex(e.s,2),this.valueElems[5].value=f.Util.hex(e.p,2),this.valueElems[6].value=String(this.nes.cycleCount)}},{key:"createContent",value:function(){var e=document.createElement("div");e.className="fixed-font";var t=[{name:"PC"},{name:"A"},{name:"X"},{name:"Y"},{name:"S"},{name:"P"},{name:"cycle"}],n=document.createElement("table");n.style.fontSize="10px",n.style.width="100%",this.valueElems=[];for(var r=0;r<t.length;++r){var i=document.createElement("tr");n.appendChild(i);var a=document.createElement("td");a.innerText=t[r].name,i.appendChild(a);var s=document.createElement("td");i.appendChild(s);var o=document.createElement("input");o.className="fixed-font",o.type="text",o.style.width="100%",s.appendChild(o),this.valueElems.push(o)}return e.appendChild(n),e}}]),t}(c["default"]);t.RegisterWnd=T;var A=3,C=100,O={opType:d.OpType.UNKNOWN,addressing:d.Addressing.UNKNOWN,bytes:1,cycle:0},w=function(e){function t(e,n){r(this,t);var a=i(this,Object.getPrototypeOf(t).call(this,e,400,160,"Trace"));a.nes=n,a.mem=new Uint8Array(A),a.bins=new Array(A);var s=a.createContent();return a.setContent(s),a.reset(),a}return a(t,e),l(t,[{key:"reset",value:function(){this.lines=[]}},{key:"updateStatus",value:function(){for(var e=this.nes.cpu,t=e.read8Raw(e.pc),n=d.kInstTable[t]||O,r=0;r<n.bytes;++r){var i=e.read8Raw(e.pc+r);this.mem[r]=i,this.bins[r]=f.Util.hex(i,2)}for(var a=n.bytes;A>a;++a)this.bins[a]="  ";var s=f.Util.hex(e.pc,4),o=this.bins.join(" "),u=p.disassemble(n,this.mem,1,e.pc);this.putConsole(s+": "+o+"   "+u)}},{key:"createContent",value:function(){var e=document.createElement("div"),t=document.createElement("textarea");return t.className="fixed-font",t.style.fontSize="14px",t.style.width="100%",t.style.height="160px",t.style.resize="none",t.style.margin="0",t.style.padding="2px",t.style.border="none",t.style.boxSizing="border-box",e.appendChild(t),this.textarea=t,e}},{key:"putConsole",value:function(e){this.lines.push(e),this.lines.length>C&&this.lines.shift(),this.textarea.value=this.lines.join("\n"),this.textarea.scrollTop=this.textarea.scrollHeight}}]),t}(c["default"]);t.TraceWnd=w;var P=function(e){function t(e,n,a,s){r(this,t);var o=i(this,Object.getPrototypeOf(t).call(this,e,384,32,"Control"));o.nes=n,o.screenWnd=a,o.audioManager=s;var u=o.createElement();return o.setContent(u),o.updateState(!0),o}return a(t,e),l(t,[{key:"updateState",value:function(e){this.stepBtn.disabled=!e,this.runBtn.disabled=!e,this.pauseBtn.disabled=e}},{key:"createElement",value:function(){var e=this,t=document.createElement("div");t.style.width="384px",t.style.height="32px",this.stepBtn=document.createElement("button"),this.stepBtn.innerText="Step",this.stepBtn.addEventListener("click",function(){e.nes.step(),e.callback("step")}),t.appendChild(this.stepBtn),this.runBtn=document.createElement("button"),this.runBtn.innerText="Run",this.runBtn.addEventListener("click",function(){e.nes.cpu.pause(!1),e.updateState(!1)}),t.appendChild(this.runBtn),this.pauseBtn=document.createElement("button"),this.pauseBtn.innerText="Pause",this.pauseBtn.addEventListener("click",function(){e.nes.cpu.pause(!0),e.updateState(!0),e.callback("paused")}),t.appendChild(this.pauseBtn);var n=document.createElement("button");n.innerText="Reset",n.addEventListener("click",function(){e.nes.reset(),e.callback("reset")}),t.appendChild(n);var r=document.createElement("button");r.innerText="Capture",r.addEventListener("click",function(){o(e.wndMgr,e.screenWnd)}),t.appendChild(r);var i=document.createElement("label"),a=document.createElement("input");return a.type="checkbox",a.addEventListener("click",function(){var t=a.checked?0:1;e.audioManager.setMasterVolume(t)}),i.appendChild(a),i.appendChild(document.createTextNode("mute")),t.appendChild(i),t}}]),t}(c["default"]);t.ControlWnd=P},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){var n=e.getBoundingClientRect(),r=t.getBoundingClientRect();return{left:r.left-n.left,top:r.top-n.top,right:r.right-n.left,bottom:r.bottom-n.top}}var i=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(u){i=!0,a=u}finally{try{!r&&o["return"]&&o["return"]()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=1e3,o=s+1,u=function(){function e(t,r,i,a){n(this,e),this.wndMgr=t,this.callback=function(){},this.root=this.createRoot(),this.root.className="wnd",this.root.style.position="absolute",this.setClientSize(r,i),this.createTitleBar(a),this.contentHolder=document.createElement("div"),this.contentHolder.className="content-holder",this.root.appendChild(this.contentHolder)}return a(e,[{key:"setContent",value:function(e){return this.contentHolder.appendChild(e),this}},{key:"setPos",value:function(e,t){return this.root.style.left=e+"px",this.root.style.top=t+"px",this}},{key:"setTitle",value:function(e){return this.titleElem.innerText=e,this}},{key:"setClientSize",value:function(t,n){return this.root.style.width=t+"px",this.root.style.height=n+e.HEADER_HEIGHT+"px",this}},{key:"getWindowSize",value:function(){var e=parseInt(this.root.style.width),t=parseInt(this.root.style.height);return{width:e,height:t}}},{key:"setCallback",value:function(e){return this.callback=e,this}},{key:"setFocus",value:function(){return this.root.focus(),this}},{key:"addMenuBar",value:function(e){var t=this;return this.menuBar=document.createElement("div"),this.menuBar.className="menu-bar",this.menuBar.style.zIndex=String(s),e.forEach(function(e){var n=document.createElement("div");n.className="menu-item pull-left",n.innerText=e.label,n.addEventListener("click",function(r){"submenu"in e&&t.addSubmenu(e,n)}),t.menuBar.appendChild(n),t.root.appendChild(t.menuBar)}),this}},{key:"addSubmenu",value:function(e,t){var n=document.createElement("div");n.className="menu-subitem-holder",n.style.zIndex=String(o),e.submenu.forEach(function(e){var t=document.createElement("div");t.className="menu-item",t.innerText=e.label,t.addEventListener("click",function(t){t.stopPropagation(),"click"in e&&e.click()}),n.appendChild(t)}),this.root.appendChild(n);var i=r(this.root,t);n.style.left=i.left-1+"px",n.style.top=i.bottom-1+"px";var a=function s(e){n.parentNode.removeChild(n),document.removeEventListener("click",s,!0)};document.addEventListener("click",a,!0)}},{key:"getRootNode",value:function(){return this.root}},{key:"close",value:function(){this.callback("close")!==!1&&(this.wndMgr.remove(this),this.root=null)}},{key:"update",value:function(){}},{key:"addResizeBox",value:function(){var t=this;this.root.classList.add("resizable");var n=8,r=[{styleParams:{right:"-1px",bottom:"-1px",cursor:"nwse-resize"},horz:"right",vert:"bottom"},{styleParams:{left:"-1px",bottom:"-1px",cursor:"nesw-resize"},horz:"left",vert:"bottom"},{styleParams:{right:"-1px",top:"-1px",cursor:"nesw-resize"},horz:"right",vert:"top"},{styleParams:{left:"-1px",top:"-1px",cursor:"nwse-resize"},horz:"left",vert:"top"}],a=64,s=24+e.HEADER_HEIGHT;r.forEach(function(r){var o=document.createElement("div");o.style.position="absolute",Object.keys(r.styleParams).forEach(function(e){o.style[e]=r.styleParams[e]}),o.style.width=o.style.height=n+"px",o.style.zIndex="100";var u=void 0,l=void 0,c=function(n){var o=t.getMousePosIn(n,t.root.parentNode),c=i(o,2),h=c[0],d=c[1],p=t.root.getBoundingClientRect(),f=t.root.parentNode.getBoundingClientRect(),v={left:p.left-f.left,top:p.top-f.top,right:p.right-f.left,bottom:p.bottom-f.top};v[r.horz]=h+u,v[r.vert]=d+l;var y=v.right-v.left-2,E=v.bottom-v.top-2;a>y&&(v[r.horz]-=(a-y)*("left"===r.horz?1:-1)),s>E&&(v[r.vert]-=(s-E)*("top"===r.vert?1:-1)),t.root.style.width=v.right-v.left-2+"px",t.root.style.height=v.bottom-v.top-2+"px",t.root.style.left=v.left+"px",t.root.style.top=v.top+"px",t.callback("resize",y,E-e.HEADER_HEIGHT)},h=function d(e){document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d);
};o.addEventListener("mousedown",function(e){e.stopPropagation(),e.preventDefault();var a=t.getMousePosIn(e,o),s=i(a,2),d=s[0],p=s[1];u="left"===r.horz?-d:n-d,l="top"===r.vert?-p:n-p,document.addEventListener("mousemove",c),document.addEventListener("mouseup",h),t.wndMgr.moveToTop(t)}),t.root.appendChild(o)})}},{key:"createRoot",value:function(){var e=this,t=document.createElement("div");return t.addEventListener("mousedown",function(t){return t.stopPropagation(),e.wndMgr.moveToTop(e),!1}),t}},{key:"createTitleBar",value:function(e){var t=this;this.titleBar=document.createElement("div"),this.titleBar.className="title-bar clearfix",this.addTitleButton(this.titleBar,"close",function(){t.close()}),this.titleElem=this.addTitle(this.titleBar,e);var n=void 0,r=void 0,a=function(e){var a=t.getMousePosIn(e,t.root.parentNode),s=i(a,2),o=s[0],u=s[1];t.root.style.left=o+n+"px",t.root.style.top=u+r+"px"},s=function o(e){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",o)};this.titleBar.addEventListener("mousedown",function(e){if(n=r=null,0===e.button){e.preventDefault();var o=t.getMousePosIn(e,t.root),u=i(o,2),l=u[0],c=u[1];return n=-l,r=-c,document.addEventListener("mousemove",a),document.addEventListener("mouseup",s),!0}}),this.root.appendChild(this.titleBar)}},{key:"addTitleButton",value:function(e,t,n){var r=document.createElement("div");return r.className=t+" btn",r.addEventListener("click",n),r.addEventListener("mousedown",function(e){e.preventDefault(),e.stopPropagation()}),e.appendChild(r),r}},{key:"addTitle",value:function(e,t){var n=document.createElement("div");return n.className="title",n.appendChild(document.createTextNode(t)),e.appendChild(n),n}},{key:"getMousePosIn",value:function(e,t){var n=t.getBoundingClientRect(),r=document.body.scrollLeft,i=document.body.scrollTop;return[e.pageX-n.left-r,e.pageY-n.top-i]}}]),e}();u.HEADER_HEIGHT=12,Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=u},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t,n){e.getRootNode().style.zIndex=String(a+(n-1-t))}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=100,s=function(){function e(t){n(this,e),this.root=t,this.windows=[]}return i(e,[{key:"add",value:function(e){this.windows.unshift(e),this.root.appendChild(e.getRootNode()),r(e,0,this.windows.length)}},{key:"remove",value:function(e){this.removeWnd(e);var t=e.getRootNode();null!=t&&t.parentNode.removeChild(t)}},{key:"moveToTop",value:function(e){var t=this.windows.length;if(!(t>0&&this.windows[0]===e))for(var n=e,i=0;t>i;++i){var a=this.windows[i];if(this.windows[i]=n,r(n,i,t),a===e)break;n=a}}},{key:"update",value:function(){this.windows.forEach(function(e){e.update()})}},{key:"removeWnd",value:function(e){var t=this.windows.indexOf(e);if(!(0>t)){this.windows.splice(t,1);for(var n=0;t>n;++n)r(this.windows[n],n,this.windows.length)}}}]),e}();Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=s}]);